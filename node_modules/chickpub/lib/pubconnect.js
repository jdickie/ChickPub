/**
 Connects with rethinkdb - util class for chicksub
 **/
var r = require('rethinkdb'),
    config = require('config'),
    _ = require('underscore');

var DB_NAME = config.environment.dbName,
    SUBSCRIBER_TABLE_NAME = 'subscriptions';

var PubConnect = function(callback) {
    this.dbHost = config.environment.host;
    this.dbPort = config.environment.dbPort;
    this.connection = null;
    this.establishConnection(callback);
};

PubConnect.prototype.establishConnection = function(connectionDoneCallback) {
    var self = this;
    r.connect({host : self.dbHost, port : self.dbPort}, function(err, conn) {
        if (err) {
            connectionDoneCallback(err);
            return;
        }
        self.connection = conn;
        connectionDoneCallback(null);
    });
};

PubConnect.prototype.getAllUidsForTopic = function(topic, gotAllUidsCallback) {
    var self = this;
    try {
        if (_.isEmpty(self.connection)) {
            throw new Error("no connection made");
        }
        r.db(DB_NAME).table(SUBSCRIBER_TABLE_NAME)
            .filter({
                "topic" : topic
            })
            .coerceTo('array')
            .run(self.connection, function(err, results) {
                if (err) {
                    throw err;
                }
                console.log("getalluids results", results);
                gotAllUidsCallback(null, results);
            });
    } catch (err) {
        gotAllUidsCallback(err);
    }
};

module.exports = PubConnect;